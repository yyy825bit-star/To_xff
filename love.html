<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xff,æˆ‘æƒ³ä½ å•¦ | 3D Heartbeat</title>

    <style>
        :root {
            /* é«˜çº§æ·±è‰²ç³»èƒŒæ™¯ï¼Œè¡¬æ‰˜ç²’å­ */
            --bg-gradient: radial-gradient(circle at center, #2b1029 0%, #1a0b1c 40%, #000000 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --accent-pink: #ff758c;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: var(--bg-gradient);
            color: #fff;
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* --- é¡¶éƒ¨æ ‡é¢˜ --- */
        .top-container {
            position: absolute;
            top: 10%;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 10;
            pointer-events: none; /* è®©é¼ æ ‡ç©¿é€ */
        }

        .title {
            font-size: 3rem;
            font-weight: 300;
            letter-spacing: 8px;
            color: #fff;
            text-shadow: 0 0 20px rgba(255, 117, 140, 0.6),
                         0 0 40px rgba(255, 117, 140, 0.3);
            margin: 0;
            opacity: 0.9;
            animation: floatText 4s ease-in-out infinite;
        }

        .subtitle {
            margin-top: 10px;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 2px;
            font-weight: 300;
        }

        @keyframes floatText {
            0%, 100% { transform: translateY(0); opacity: 0.9; }
            50% { transform: translateY(-10px); opacity: 1; }
        }

        /* --- åº•éƒ¨æ§åˆ¶æ  (æç®€é£æ ¼) --- */
        .control-bar {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 12px 25px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            backdrop-filter: blur(10px);
            z-index: 20;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .control-bar:hover {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 40px rgba(255, 117, 140, 0.2);
        }

        .music-info {
            display: flex;
            flex-direction: column;
            width: 160px;
        }

        .song-name {
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: rgba(255, 255, 255, 0.9);
        }

        /* å¾‹åŠ¨æ¡ */
        .beat-bar {
            height: 3px;
            width: 0%;
            background: var(--accent-pink);
            margin-top: 4px;
            border-radius: 2px;
            box-shadow: 0 0 8px var(--accent-pink);
            transition: width 0.05s;
        }

        button {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
        }

        button:hover {
            background: var(--accent-pink);
            border-color: var(--accent-pink);
            transform: scale(1.1);
        }
        
        button.play-active {
            background: var(--accent-pink);
            border-color: var(--accent-pink);
            box-shadow: 0 0 15px rgba(255, 117, 140, 0.5);
        }

        /* åŠ è½½æç¤º */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            letter-spacing: 2px;
            pointer-events: none;
            transition: opacity 0.5s;
        }

    </style>
</head>
<body>

    <div class="top-container">
        <h1 class="title">xff,æˆ‘æƒ³ä½ å•¦</h1>
    </div>

    <div id="loading">âœ¨ ENGINE STARTING...</div>

    <canvas id="canvas"></canvas>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-bar">
        <button id="playBtn" onclick="toggleMusic()">â–¶</button>
        
        <div class="music-info">
            <div class="song-name" id="songTitle">ç‚¹å‡»æ’­æ”¾å¼€å¯å¾‹åŠ¨</div>
            <div class="beat-bar" id="beatVis"></div>
        </div>

        <button onclick="nextMusic()">â­</button>
    </div>

    <script>
        /**
         * ==========================================
         * 1. éŸ³ä¹æ’­æ”¾ä¸åˆ†æç³»ç»Ÿ
         * ==========================================
         */
        // ğŸ“¢ è¯·ç¡®ä¿ MP3 æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ä¸‹
        const playlist = [
            'zdnygj.mp3',
            'What_is_Love.mp3',
            'ezj.mp3',
            'some.mp3',
            'Crush.mp3'
        ];

        let trackIndex = 0;
        let isPlaying = false;
        let audioCtx, analyser, source;
        const audio = new Audio();
        audio.crossOrigin = "anonymous";
        let dataArray;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 512; // æé«˜é‡‡æ ·ç²¾åº¦
                source = audioCtx.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(audioCtx.destination);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function toggleMusic() {
            initAudio();
            const btn = document.getElementById('playBtn');
            
            if (isPlaying) {
                audio.pause();
                btn.innerText = "â–¶";
                btn.classList.remove('play-active');
            } else {
                if (!audio.src) audio.src = playlist[trackIndex];
                audio.play().catch(e => console.log("æ’­æ”¾éœ€è¦äº¤äº’:", e));
                btn.innerText = "â¸";
                btn.classList.add('play-active');
                updateTitle();
            }
            isPlaying = !isPlaying;
        }

        function nextMusic() {
            trackIndex = (trackIndex + 1) % playlist.length;
            audio.src = playlist[trackIndex];
            if (isPlaying) audio.play();
            updateTitle();
        }

        function updateTitle() {
            const name = playlist[trackIndex];
            document.getElementById('songTitle').innerText = "ğŸµ " + name;
        }

        // è·å–ä½éŸ³èƒ½é‡å€¼ (0 ~ 1) - ç”¨äºé©±åŠ¨å¿ƒè·³
        function getBassEnergy() {
            if (!analyser) return 0;
            analyser.getByteFrequencyData(dataArray);
            
            // æŠ“å–ä½é¢‘æ®µ (Bass)
            let sum = 0;
            for (let i = 0; i < 20; i++) {
                sum += dataArray[i];
            }
            let avg = sum / 20;
            
            // å¯è§†åŒ–æ¡
            document.getElementById('beatVis').style.width = (avg / 2.55) + "%";
            
            // è¿”å›å½’ä¸€åŒ–æ•°å€¼ï¼Œå¹¶åšä¸€ç‚¹æŒ‡æ•°å¢å¼ºï¼Œè®©é‡éŸ³æ›´æ˜æ˜¾
            let val = avg / 255;
            return val * val; // å¹³æ–¹æ›²çº¿ï¼Œè®©å¼±éŸ³æ›´å¼±ï¼Œå¼ºéŸ³æ›´å¼º
        }

        /**
         * ==========================================
         * 2. é«˜çº§ 3D ç²’å­å¼•æ“
         * ==========================================
         */
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        let width, height;
        let particles = [];
        
        // æ ¸å¿ƒå‚æ•°
        const PARTICLE_COUNT = 1800; // ç²’å­æ•°é‡
        const HEART_SIZE = 15;       // çˆ±å¿ƒåŸºç¡€å¤§å°
        const COLORS = ['#ff758c', '#ff7eb3', '#ffa585', '#ffffff', '#c21500'];

        // åˆå§‹åŒ–ç”»å¸ƒ
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // éšè— loading
        setTimeout(() => {
            const load = document.getElementById('loading');
            load.style.opacity = 0;
            setTimeout(() => load.style.display = 'none', 500);
        }, 800);

        /**
         * ğŸ’– 3D çˆ±å¿ƒæ•°å­¦ç”Ÿæˆå™¨
         * ä½¿ç”¨çƒåæ ‡ç³» + çˆ±å¿ƒæ–¹ç¨‹
         */
        function getHeartPoint() {
            // éšæœºè§’åº¦
            let u = Math.random() * Math.PI * 2;
            let v = Math.random() * Math.PI;
            
            // å¦ä¸€ç§æ›´åŠ é¥±æ»¡çš„çˆ±å¿ƒæ–¹ç¨‹ (3D Heart Surface)
            // x = 16sin^3(t)
            // y = 13cos(t) - 5cos(2t) - 2cos(3t) - cos(4t)
            // z = æ‰©å……åšåº¦
            
            // è¿™é‡Œä½¿ç”¨æ›´é€‚åˆç²’å­äº‘çš„éšæœºåˆ†å¸ƒç®—æ³•
            let t = Math.random() * Math.PI * 2;
            
            // 2D åŸºç¡€è½®å»“
            let x = 16 * Math.pow(Math.sin(t), 3);
            let y = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
            
            // Z è½´åšåº¦ï¼šä¸­å¿ƒåšï¼Œè¾¹ç¼˜è–„ï¼Œå¹¶åŠ å…¥éšæœºæ•£å°„
            // è¿™é‡Œçš„æ•°å­¦ trick æ˜¯è®© Z éš x,y çš„æ”¶ç¼©è€Œæ”¶ç¼©
            let scale = Math.random(); // å†…éƒ¨å¡«å……
            // è®©çˆ±å¿ƒçœ‹èµ·æ¥æœ‰ä½“ç§¯
            let z = (Math.random() - 0.5) * 10 * scale; 
            
            // ç¨å¾®è®© x, y ä¹Ÿéšæœºä¸€ç‚¹ï¼Œå¡«æ»¡å†…éƒ¨
            // ä½¿ç”¨ sqrt(scale) è®©ç²’å­æ›´èšé›†åœ¨è¡¨é¢
            let s = Math.sqrt(Math.random()); 
            
            return {
                x: x * s,
                y: y * s,
                z: z * s
            };
        }

        class Particle {
            constructor() {
                this.reset();
                // åˆå§‹éšæœºä½ç½®ï¼Œåšå…¥åœºåŠ¨ç”»
                this.y = Math.random() * height;
            }

            reset() {
                const pos = getHeartPoint();
                this.originX = pos.x * HEART_SIZE;
                this.originY = pos.y * HEART_SIZE;
                this.originZ = pos.z * HEART_SIZE;
                
                this.x = this.originX;
                this.y = this.originY;
                this.z = this.originZ;

                this.size = Math.random() * 2 + 0.5; // ç²’å­å¤§å°
                this.color = COLORS[Math.floor(Math.random() * COLORS.length)];
                
                // é—ªçƒå‚æ•°
                this.alpha = Math.random();
                this.fadeSpeed = Math.random() * 0.02 + 0.005;
            }

            update(beat, rotationY) {
                // 1. æ—‹è½¬é€»è¾‘ (ç»•Yè½´)
                // 3D æ—‹è½¬çŸ©é˜µå…¬å¼
                // x' = x*cos - z*sin
                // z' = x*sin + z*cos
                const cos = Math.cos(rotationY);
                const sin = Math.sin(rotationY);

                // 2. å¿ƒè·³è†¨èƒ€é€»è¾‘
                // å½“ bass é‡éŸ³å‡ºç°æ—¶ï¼Œbeat å€¼å¤§ï¼Œç²’å­å‘å¤–æ‰©æ•£
                // ä½¿ç”¨ origin åæ ‡ä½œä¸ºåŸºå‡†æ–¹å‘
                const beatScale = 1 + (beat * 0.8); // æ”¾å¤§å€æ•°ï¼Œæœ€å¤§ 1.8 å€

                let tx = this.originX * beatScale;
                let ty = this.originY * beatScale;
                let tz = this.originZ * beatScale;

                // åº”ç”¨æ—‹è½¬
                let rx = tx * cos - tz * sin;
                let rz = tx * sin + tz * cos;
                let ry = ty;

                // 3. 3D é€è§†æŠ•å½± (Perspective Projection)
                // focalLength ç„¦è·
                const f = 400; 
                // z è½´åç§»ï¼ŒæŠŠæ¨¡å‹æ¨è¿œä¸€ç‚¹ï¼Œä¸ç„¶ä¼šç³Šåœ¨è„¸ä¸Š
                const zOffset = rz + f; 
                
                if (zOffset > 0) {
                    const projection = f / zOffset;
                    this.screenX = width / 2 + rx * projection;
                    this.screenY = height / 2 + ry * projection;
                    this.screenScale = projection; // è¿œå°è¿‘å¤§
                    this.visible = true;
                } else {
                    this.visible = false;
                }

                // é—ªçƒæ›´æ–°
                this.alpha += this.fadeSpeed;
                if (this.alpha > 1 || this.alpha < 0.2) this.fadeSpeed *= -1;
            }

            draw(ctx) {
                if (!this.visible) return;

                ctx.globalAlpha = this.alpha;
                ctx.fillStyle = this.color;
                
                // æ ¹æ®è·ç¦»è°ƒæ•´å¤§å°
                let s = this.size * this.screenScale;
                
                ctx.beginPath();
                ctx.arc(this.screenX, this.screenY, s, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // åˆå§‹åŒ–ç²’å­
        for (let i = 0; i < PARTICLE_COUNT; i++) {
            particles.push(new Particle());
        }

        // åŠ¨ç”»å¾ªç¯
        let rotationAngle = 0;
        
        function animate() {
            // æ‹–å°¾æ•ˆæœï¼Œè®©è¿åŠ¨æ›´ä¸æ»‘
            // ä½¿ç”¨æ·±è‰²åŠé€æ˜é®ç½©
            ctx.fillStyle = 'rgba(0, 0, 0, 0.15)'; // è¿™é‡Œçš„é€æ˜åº¦å†³å®šæ‹–å°¾é•¿åº¦ï¼Œè¶Šå°è¶Šé•¿
            ctx.fillRect(0, 0, width, height);

            // è·å–éŸ³ä¹èƒ½é‡
            const beat = getBassEnergy();
            
            // è‡ªåŠ¨æ—‹è½¬ + éŸ³ä¹åŠ é€Ÿæ—‹è½¬
            rotationAngle += 0.005 + (beat * 0.02);

            // æ›´æ–°ç»˜åˆ¶æ‰€æœ‰ç²’å­
            // å…³é”®ï¼šæŒ‰ Z è½´æ·±åº¦æ’åºï¼Œç¡®ä¿é®æŒ¡å…³ç³»æ­£ç¡®ï¼ˆè™½ç„¶ç²’å­å¾ˆå°å½±å“ä¸å¤§ï¼Œä½†æ’åºåæ›´æœ‰è´¨æ„Ÿï¼‰
            // è¿™é‡Œä¸ºäº†æ€§èƒ½ç•¥å»æ’åºï¼Œå› ä¸º additive blending æ•ˆæœæ›´å¥½
            
            ctx.globalCompositeOperation = 'lighter'; // å åŠ æ¨¡å¼ï¼Œè®©é‡å ç²’å­å‘å…‰

            particles.forEach(p => {
                p.update(beat, rotationAngle);
                p.draw(ctx);
            });

            ctx.globalCompositeOperation = 'source-over'; // æ¢å¤é»˜è®¤

            requestAnimationFrame(animate);
        }

        animate();

    </script>
</body>
</html>