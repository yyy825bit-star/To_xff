<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xff,æˆ‘æƒ³ä½ å•¦ | 3D Heartbeat</title>

    <style>
        :root {
            /* é«˜çº§æ·±è‰²ç³»èƒŒæ™¯ï¼Œè¡¬æ‰˜ç²’å­ */
            --bg-gradient: radial-gradient(circle at center, #2b1029 0%, #1a0b1c 40%, #000000 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --accent-pink: #ff758c;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: var(--bg-gradient);
            color: #fff;
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* --- é¡¶éƒ¨æ ‡é¢˜ --- */
        .top-container {
            position: absolute;
            top: 10%;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 10;
            pointer-events: none; /* è®©é¼ æ ‡ç©¿é€ */
        }

        .title {
            font-size: 3rem;
            font-weight: 300;
            letter-spacing: 8px;
            color: #fff;
            text-shadow: 0 0 20px rgba(255, 117, 140, 0.6),
                         0 0 40px rgba(255, 117, 140, 0.3);
            margin: 0;
            opacity: 0.9;
            animation: floatText 4s ease-in-out infinite;
        }

        .subtitle {
            margin-top: 10px;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 2px;
            font-weight: 300;
        }

        @keyframes floatText {
            0%, 100% { transform: translateY(0); opacity: 0.9; }
            50% { transform: translateY(-10px); opacity: 1; }
        }

        /* --- åº•éƒ¨æ§åˆ¶æ  (æç®€é£æ ¼) --- */
        .control-bar {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 12px 25px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            backdrop-filter: blur(10px);
            z-index: 20;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .control-bar:hover {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 40px rgba(255, 117, 140, 0.2);
        }

        .music-info {
            display: flex;
            flex-direction: column;
            width: 160px;
        }

        .song-name {
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: rgba(255, 255, 255, 0.9);
        }

        /* å¾‹åŠ¨æ¡ */
        .beat-bar {
            height: 3px;
            width: 0%;
            background: var(--accent-pink);
            margin-top: 4px;
            border-radius: 2px;
            box-shadow: 0 0 8px var(--accent-pink);
            transition: width 0.05s;
        }

        button {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
        }

        button:hover {
            background: var(--accent-pink);
            border-color: var(--accent-pink);
            transform: scale(1.1);
        }
        
        button.play-active {
            background: var(--accent-pink);
            border-color: var(--accent-pink);
            box-shadow: 0 0 15px rgba(255, 117, 140, 0.5);
        }

        /* åŠ è½½æç¤º */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            letter-spacing: 2px;
            pointer-events: none;
            transition: opacity 0.5s;
        }

    </style>
</head>
<body>

    <div class="top-container">
        <h1 class="title">xff,æˆ‘æƒ³ä½ å•¦</h1>
    </div>

    <div id="loading">âœ¨ ENGINE STARTING...</div>

    <canvas id="canvas"></canvas>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-bar">
        <button id="playBtn" onclick="toggleMusic()">â–¶</button>
        
        <div class="music-info">
            <div class="song-name" id="songTitle">ç‚¹å‡»æ’­æ”¾å¼€å¯å¾‹åŠ¨</div>
            <div class="beat-bar" id="beatVis"></div>
        </div>

        <button onclick="nextMusic()">â­</button>
    </div>

    <script>
        /**
         * ==========================================
         * 1. éŸ³ä¹æ’­æ”¾ä¸åˆ†æç³»ç»Ÿ
         * ==========================================
         */
        const playlist = [
            'music/zdnygj.mp3',
            'music/What_is_Love.mp3',
            'music/ezj.mp3',
            'music/some.mp3',
            'music/Crush.mp3'
        ];

        let trackIndex = 0;
        let isPlaying = false;
        let audioCtx, analyser, source;
        const audio = new Audio();
        audio.crossOrigin = "anonymous";
        let dataArray;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 512; 
                source = audioCtx.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(audioCtx.destination);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function toggleMusic() {
            initAudio();
            const btn = document.getElementById('playBtn');
            
            if (isPlaying) {
                audio.pause();
                btn.innerText = "â–¶";
                btn.classList.remove('play-active');
            } else {
                if (!audio.src) audio.src = playlist[trackIndex];
                audio.play().catch(e => console.log("æ’­æ”¾éœ€è¦äº¤äº’:", e));
                btn.innerText = "â¸";
                btn.classList.add('play-active');
                updateTitle();
            }
            isPlaying = !isPlaying;
        }

        function nextMusic() {
            trackIndex = (trackIndex + 1) % playlist.length;
            audio.src = playlist[trackIndex];
            if (isPlaying) audio.play();
            updateTitle();
        }

        function updateTitle() {
            const name = playlist[trackIndex];
            document.getElementById('songTitle').innerText = "ğŸµ " + name;
        }

        function getBassEnergy() {
            if (!analyser) return 0;
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for (let i = 0; i < 20; i++) sum += dataArray[i];
            let avg = sum / 20;
            document.getElementById('beatVis').style.width = (avg / 2.55) + "%";
            let val = avg / 255;
            return val * val; 
        }

        /**
         * ==========================================
         * 2. é«˜çº§ 3D ç²’å­å¼•æ“ (ä¼˜åŒ–ç‰ˆ - åŠ¨æ€æ¸å˜)
         * ==========================================
         */
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        let width, height;
        let particles = [];
        
        const PARTICLE_COUNT = 1800; 
        const HEART_SIZE = 15;       

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        setTimeout(() => {
            const load = document.getElementById('loading');
            load.style.opacity = 0;
            setTimeout(() => load.style.display = 'none', 500);
        }, 800);

        function getHeartPoint() {
            let t = Math.random() * Math.PI * 2;
            let x = 16 * Math.pow(Math.sin(t), 3);
            let y = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
            let scale = Math.random(); 
            let z = (Math.random() - 0.5) * 10 * scale; 
            let s = Math.sqrt(Math.random()); 
            return {
                x: x * s,
                y: y * s,
                z: z * s
            };
        }

        class Particle {
            constructor() {
                this.reset();
                this.y = Math.random() * height;
            }

            reset() {
                const pos = getHeartPoint();
                this.originX = pos.x * HEART_SIZE;
                this.originY = pos.y * HEART_SIZE;
                this.originZ = pos.z * HEART_SIZE;
                
                this.x = this.originX;
                this.y = this.originY;
                this.z = this.originZ;

                this.size = Math.random() * 2 + 0.5; 
                
                this.baseHue = 340; // åŸºç¡€è‰²ç›¸ï¼šç²‰è‰²
                
                this.alpha = Math.random();
                this.fadeSpeed = Math.random() * 0.02 + 0.005;
                this.phase = Math.random() * Math.PI * 2; 
                
                // æ·»åŠ åŠ¨æ€æ¸å˜ç›¸å…³å±æ€§
                this.huePhase = Math.random() * Math.PI * 2; // ç”¨äºè‰²ç›¸å˜åŒ–
                this.lightPhase = Math.random() * Math.PI * 2; // ç”¨äºäº®åº¦å˜åŒ–
            }

            update(beat, rotationY, time) {
                const cos = Math.cos(rotationY);
                const sin = Math.sin(rotationY);
                const beatScale = 1 + (beat * 0.8); 

                let tx = this.originX * beatScale;
                let ty = this.originY * beatScale;
                let tz = this.originZ * beatScale;

                let rx = tx * cos - tz * sin;
                let rz = tx * sin + tz * cos;
                let ry = ty;

                const f = 400; 
                const zOffset = rz + f; 
                
                if (zOffset > 0) {
                    const projection = f / zOffset;
                    this.screenX = width / 2 + rx * projection;
                    this.screenY = height / 2 + ry * projection;
                    this.screenScale = projection; 
                    
                    this.depthRatio = (rz + 20) / 40; 
                    
                    this.visible = true;
                } else {
                    this.visible = false;
                }

                // é—ªçƒä¸å‘¼å¸
                this.alpha = 0.3 + Math.abs(Math.sin(time + this.phase)) * 0.7;
                
                // æ›´æ–°åŠ¨æ€æ¸å˜å‚æ•°
                this.currentHue = this.baseHue + Math.sin(time * 0.5 + this.huePhase) * 20;
                this.currentLightness = 50 + Math.sin(time * 0.7 + this.lightPhase) * 10 + (this.screenScale * 20);
            }

            draw(ctx, time) {
                if (!this.visible) return;

                let r = this.size * this.screenScale * 1.5; 
                if (r < 0.1) return;

                const gradient = ctx.createRadialGradient(
                    this.screenX, this.screenY, 0, 
                    this.screenX, this.screenY, r,
                    this.screenX, this.screenY, r * 1.5 // æ‰©å±•æ¸å˜èŒƒå›´
                );

                // åŠ¨æ€æ¸å˜ï¼šä¸­å¿ƒäº®è‰² -> ä¸­é—´ä¸»ä½“è‰² -> è¾¹ç¼˜é€æ˜
                gradient.addColorStop(0, `hsla(${this.currentHue}, 100%, 90%, ${this.alpha})`);
                gradient.addColorStop(0.4, `hsla(${this.currentHue}, 80%, ${this.currentLightness}%, ${this.alpha * 0.8})`);
                gradient.addColorStop(0.7, `hsla(${this.currentHue + 10}, 70%, ${this.currentLightness - 10}%, ${this.alpha * 0.4})`);
                gradient.addColorStop(1, `hsla(${this.currentHue + 20}, 60%, 30%, 0)`);

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(this.screenX, this.screenY, r, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        for (let i = 0; i < PARTICLE_COUNT; i++) {
            particles.push(new Particle());
        }

        let rotationAngle = 0;
        let time = 0;
        
        function animate() {
            time += 0.02; 

            // æ‹–å°¾é®ç½©
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; 
            ctx.fillRect(0, 0, width, height);

            const beat = getBassEnergy();
            rotationAngle += 0.005 + (beat * 0.02);

            // å åŠ æ¨¡å¼
            ctx.globalCompositeOperation = 'lighter'; 

            particles.forEach(p => {
                p.update(beat, rotationAngle, time);
                p.draw(ctx, time); // ä¼ é€’æ—¶é—´å‚æ•°
            });

            ctx.globalCompositeOperation = 'source-over'; 

            requestAnimationFrame(animate);
        }

        animate();

    </script>
</body>
</html>
